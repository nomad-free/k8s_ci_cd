# =============================================================================
# Terraform Plan - PRì—ì„œ ìë™ ì‹¤í–‰
# =============================================================================
# íŠ¸ë¦¬ê±°: terraform/ í´ë” ë³€ê²½ì´ ìˆëŠ” PR ìƒì„±/ìˆ˜ì • ì‹œ
# ë™ì‘:
#   - developìœ¼ë¡œ PR â†’ dev í™˜ê²½ Plan
#   - mainìœ¼ë¡œ PR â†’ prod í™˜ê²½ Plan
# =============================================================================

name: Terraform Plan

on:
  pull_request:
    branches: [develop, main]
    paths:
      - "terraform/**"

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AWS_REGION: us-east-1
  TF_VERSION: "1.10.0"

jobs:
  plan:
    name: ğŸ“‹ Terraform Plan
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # PR ëŒ€ìƒ ë¸Œëœì¹˜ì— ë”°ë¼ í™˜ê²½ ê²°ì •
      - name: ğŸ¯ Determine Environment
        id: env
        run: |
          if [ "${{ github.base_ref }}" == "main" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi
          echo "Environment: ${{ github.base_ref }} -> $(cat $GITHUB_OUTPUT | grep environment)"

      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: terraform-plan-${{ steps.env.outputs.environment }}-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: ğŸ“¦ Terraform Init
        id: init
        working-directory: terraform
        run: terraform init -backend-config=backends/${{ steps.env.outputs.environment }}.hcl -no-color

      - name: âœ… Terraform Validate
        id: validate
        working-directory: terraform
        run: terraform validate -no-color

      - name: ğŸ“‹ Terraform Plan
        id: plan
        working-directory: terraform
        run: |
          terraform plan -var-file=${{ steps.env.outputs.environment }}.tfvars -no-color -out=tfplan 2>&1 | tee plan_output.txt
          echo "exitcode=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸ’¬ Comment Plan on PR
        uses: actions/github-script@v7
        if: always()
        env:
          PLAN_OUTPUT: ${{ steps.plan.outputs.stdout }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const environment = '${{ steps.env.outputs.environment }}';
            const initOutcome = '${{ steps.init.outcome }}';
            const validateOutcome = '${{ steps.validate.outcome }}';
            const planOutcome = '${{ steps.plan.outcome }}';

            let planOutput = '';
            try {
              planOutput = fs.readFileSync('terraform/plan_output.txt', 'utf8');
            } catch (e) {
              planOutput = 'Plan output not available';
            }

            // ì¶œë ¥ ê¸¸ì´ ì œí•œ (GitHub ì½”ë©˜íŠ¸ ì œí•œ)
            const maxLength = 60000;
            if (planOutput.length > maxLength) {
              planOutput = planOutput.substring(0, maxLength) + '\n\n... (truncated)';
            }

            let statusEmoji = 'âœ…';
            if (planOutcome !== 'success') statusEmoji = 'âŒ';

            const output = `### ${statusEmoji} Terraform Plan - \`${environment}\` Environment

            | Step | Status |
            |------|--------|
            | ğŸ“¦ Init | \`${initOutcome}\` |
            | âœ… Validate | \`${validateOutcome}\` |
            | ğŸ“‹ Plan | \`${planOutcome}\` |

            <details><summary>ğŸ“„ Show Plan Output</summary>

            \`\`\`hcl
            ${planOutput}
            \`\`\`

            </details>

            ---
            *Triggered by @${{ github.actor }} â€¢ Commit: \`${{ github.event.pull_request.head.sha }}\`*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: âŒ Fail if Plan Failed
        if: steps.plan.outcome == 'failure'
        run: |
          echo "::error::Terraform plan failed!"
          exit 1
