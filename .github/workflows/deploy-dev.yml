name: Deploy to Dev
on:
  push:
    branches: [develop]
    paths-ignore:
      - "README.md"
      - "docs/**"

concurrency:
  group: deploy-dev-${{ github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write # [ÌïÑÏàò] AWS OIDC Ïù∏Ï¶ùÏùÑ ÏúÑÌïú Í∂åÌïú
  contents: read # ÏÜåÏä§ ÏΩîÎìú ÏùΩÍ∏∞ Í∂åÌïú
  packages: write # GitHub Packages ÏÇ¨Ïö© Ïãú ÌïÑÏöî (Ïó¨Í∏∞ÏÑ† ECRÏù¥Îùº ÏÑ†ÌÉùÏ†Å)
  attestations: write # [2025 New] Ïù¥ÎØ∏ÏßÄ Î¨¥Í≤∞ÏÑ± Ï¶ùÎ™ÖÏÑú(Attestation) ÏûëÏÑ± Í∂åÌïú

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: k8s-ci-cd-app
  EKS_CLUSTER_NAME: k8s-ci-cd-dev
  ENVIRONMENT: dev
  # [2025 Standard] Node.js 22 (LTS 'Jod') ÏÇ¨Ïö©
  NODE_VERSION: "22"

jobs:
  # 1. CI Ï≤¥ÌÅ¨ (ÌÖåÏä§Ìä∏ & Î¶∞Ìä∏)
  # Î∞∞Ìè¨ Ï†ÑÏóê ÏΩîÎìúÍ∞Ä Ï†ïÏÉÅÏù∏ÏßÄ ÌôïÏù∏ÌïòÎäî Gatekeeper Ïó≠Ìï†ÏùÑ Ìï©ÎãàÎã§.
  ci:
    name: üîç CI Checks
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        # [2025.04 Ï∂úÏãú] actions/checkout@v5
        # - Fetch ÏÑ±Îä• Í∞úÏÑ† Î∞è Sparse Checkout Í∏∞Î≥∏ ÏßÄÏõê Í∞ïÌôî
        uses: actions/checkout@v5

      - name: üü¢ Setup Node.js
        # [2025.02 Ï∂úÏãú] actions/setup-node@v5
        # - Corepack ÏûêÎèô ÌôúÏÑ±Ìôî Î∞è Ï∫êÏãú Î°úÏßÅ Í∞úÏÑ†
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: app/package-lock.json

      - name: üì¶ Install dependencies
        working-directory: ./app
        run: npm ci

      - name: üîç Run lint
        working-directory: ./app
        run: npm run lint

      - name: üß™ Run tests
        working-directory: ./app
        run: npm test

  # 2. ÎπåÎìú Î∞è ECR Ìë∏Ïãú
  build:
    name: üèóÔ∏è Build & Push
    runs-on: ubuntu-latest
    needs: ci
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
      image_uri: ${{ steps.build.outputs.image_uri }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v5

      - name: üîê Configure AWS credentials
        # [2025.03 Ï∂úÏãú] aws-actions/configure-aws-credentials@v5
        # - EKS Access Entry Ìò∏ÌôòÏÑ± Í∞ïÌôî Î∞è ÏÑ∏ÏÖò ÌÉúÍπÖ ÏûêÎèôÌôî
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: gha-dev-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: üîê Login to Amazon ECR
        id: login-ecr
        # [2025.02 Ï∂úÏãú] aws-actions/amazon-ecr-login@v3
        uses: aws-actions/amazon-ecr-login@v3

      - name: üìã Generate image metadata
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          IMAGE_TAG="${SHORT_SHA}-${TIMESTAMP}-dev"
          echo "version=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: üîß Set up Docker Buildx
        # [2025.05 Ï∂úÏãú] docker/setup-buildx-action@v4
        # - Buildkit v0.15+ Í∏∞Î≥∏ ÏßÄÏõê (ÎπåÎìú ÏÜçÎèÑ 30% Ìñ•ÏÉÅ)
        uses: docker/setup-buildx-action@v4

      - name: üê≥ Build and push Docker image
        id: build
        # [2025.06 Ï∂úÏãú] docker/build-push-action@v7
        uses: docker/build-push-action@v7
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        with:
          context: ./app
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.version }}
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest-dev
          # [2025 Best Practice] GitHub Actions Ï∫êÏãú Î∞±ÏóîÎìú ÌôúÏö© (ÏÜçÎèÑ ÏµúÏ†ÅÌôî)
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # [2025 Best Practice] Í≥µÍ∏âÎßù Î≥¥Ïïà: Ïù¥ÎØ∏ÏßÄ Ï∂úÏ≤ò(Provenance) Î∞è SBOM Ï¶ùÎ™Ö ÏÉùÏÑ±
          provenance: true
          sbom: true

      - name: üì§ Output Image URI
        run: |
          echo "image_uri=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.version }}" >> $GITHUB_OUTPUT

  # 3. K8s Î∞∞Ìè¨ (Kustomize)
  deploy:
    name: üöÄ Deploy to Dev
    runs-on: ubuntu-latest
    needs: build
    environment: dev

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v5

      - name: üîê Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: gha-dev-deploy-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: üîß Setup kubectl
        # [2025.07 Ï∂úÏãú] azure/setup-kubectl@v5
        # - ÏµúÏã† K8s 1.34 Î∞îÏù¥ÎÑàÎ¶¨ Í∏∞Î≥∏ ÏßÄÏõê
        uses: azure/setup-kubectl@v5
        with:
          version: "v1.34.0"

      - name: üîó Configure kubectl
        # [2025] aws-auth ConfigMap ÏàòÏ†ï ÏóÜÏù¥ Access Entry Í∂åÌïúÏúºÎ°ú Ï¶âÏãú Ï†ëÍ∑º
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ env.EKS_CLUSTER_NAME }}

      - name: üìù Update image in Kustomization
        # kustomizeÎäî ÏµúÏã† Runner Ïù¥ÎØ∏ÏßÄÏóê Í∏∞Î≥∏ Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏùå
        run: |
          cd kustomize/overlays/dev
          kustomize edit set image app=${{ needs.build.outputs.image_uri }}

      - name: üöÄ Deploy to Kubernetes
        run: |
          kubectl apply -k kustomize/overlays/dev/

      - name: ‚è≥ Wait for rollout
        # Î∞∞Ìè¨ ÏÉÅÌÉú ÎåÄÍ∏∞ (ÏµúÎåÄ 5Î∂Ñ)
        run: |
          kubectl rollout status deployment/app -n app-dev --timeout=300s

      - name: ‚úÖ Verify deployment
        run: |
          echo "=== Pod Status ==="
          kubectl get pods -n app-dev -l app.kubernetes.io/name=k8s-ci-cd

  # 4. Ìó¨Ïä§ Ï≤¥ÌÅ¨
  health-check:
    name: üè• Health Check
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: üîê Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: üîó Configure kubectl
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ env.EKS_CLUSTER_NAME }}

      - name: üè• Run health check
        run: |
          # Ìè¨Ìä∏ Ìè¨ÏõåÎî©ÏùÑ ÌÜµÌï¥ ÎÇ¥Î∂Ä ÏÑúÎπÑÏä§ Ï†ëÍ∑º (ÌîÑÎ°ùÏãú)
          kubectl port-forward svc/app-service 8080:80 -n app-dev &
          PF_PID=$!
          sleep 10

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health || echo "000")

          # Ìè¨Ìä∏ Ìè¨ÏõåÎî© ÌîÑÎ°úÏÑ∏Ïä§ Ï¢ÖÎ£å
          kill $PF_PID 2>/dev/null || true

          if [ "$HTTP_STATUS" == "200" ]; then
            echo "‚úÖ Health check passed!"
          else
            echo "‚ùå Health check failed! (HTTP $HTTP_STATUS)"
            exit 1
          fi
