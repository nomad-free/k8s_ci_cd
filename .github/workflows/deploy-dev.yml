name: Deploy to Dev

# [Î≥ÄÍ≤Ω 1] CI ÏõåÌÅ¨ÌîåÎ°úÏö∞Í∞Ä ÎÅùÎÇ¨ÏùÑ Îïå Ìä∏Î¶¨Í±∞Îê®
on:
  workflow_run:
    workflows: ["CI"] # ci.yml ÌååÏùº ÎÇ¥Ïùò 'name'Í≥º ÏùºÏπòÌï¥Ïïº Ìï®
    types:
      - completed
    branches:
      - develop

permissions:
  id-token: write
  contents: read
  packages: write

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: k8s-ci-cd-app
  EKS_CLUSTER_NAME: k8s-ci-cd-dev
  ENVIRONMENT: dev

jobs:
  build-and-deploy:
    name: üèóÔ∏è Build & Deploy (Dev)
    runs-on: ubuntu-latest
    # [Ï§ëÏöî] CIÍ∞Ä 'ÏÑ±Í≥µ'ÌñàÏùÑ ÎïåÎßå Ïã§Ìñâ
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: gha-dev-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: üîê Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: üîß Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üê≥ Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./app
          push: true
          tags: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest-dev
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: üîß Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: üîó Configure kubectl
        run: aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}

      # Dev ÌôòÍ≤ΩÏùÄ Î≥ÑÎèÑÏùò Î°§ÏïÑÏõÉ ÎåÄÍ∏∞ÎÇò Î≥¥Ïïà Ïä§Ï∫î ÏóÜÏù¥ Ï¶âÏãú Î∞òÏòÅ
      - name: üöÄ Deploy to Dev
        run: |
          cd kustomize/overlays/dev
          kustomize edit set image app=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest-dev
          kubectl apply -k .
          kubectl rollout status deployment/app -n app-dev --timeout=180s

      - name: üè• Run health check
        run: |
          kubectl port-forward svc/app-service 8080:80 -n app-dev &
          PF_PID=$!
          sleep 10
          # [ÏàòÏ†ïÎê®] Ï†ïÌôïÌïú Health Check Í≤ΩÎ°ú (/api/v1/health)
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/v1/health || echo "000")
          kill $PF_PID 2>/dev/null || true
          if [ "$HTTP_STATUS" == "200" ]; then
            echo "‚úÖ Health check passed!"
          else
            echo "‚ùå Health check failed! (HTTP: $HTTP_STATUS)"
            exit 1
          fi

      # Dev ÏïåÎ¶ºÏùÄ Í∞ÑÏÜåÌïòÍ≤å
      - name: üì¢ Notify Slack
        if: always()
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook-type: webhook-trigger
          payload: |
            {
              "text": "Dev Deploy: ${{ job.status }}",
              "blocks": [
                 {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Dev Deploy Finished* :${{ job.status == 'success' && 'white_check_mark' || 'x' }}:\nBranch: `develop`"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
