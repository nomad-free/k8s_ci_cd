name: Deploy to Dev

# [Î≥ÄÍ≤Ω 1] CI ÏõåÌÅ¨ÌîåÎ°úÏö∞Í∞Ä ÎÅùÎÇ¨ÏùÑ Îïå Ìä∏Î¶¨Í±∞Îê®
on:
  workflow_run:
    workflows: ["CI"] # ci.yml ÌååÏùº ÎÇ¥Ïùò 'name'Í≥º ÏùºÏπòÌï¥Ïïº Ìï®
    types:
      - completed
    branches:
      - develop

permissions:
  id-token: write
  contents: read
  packages: write

# ÌôòÍ≤Ω Î≥ÄÏàòÎ•º Î≥ÄÏàò(vars)ÏôÄ ÏãúÌÅ¨Î¶ø(secrets)ÏóêÏÑú Í∞ÄÏ†∏ÏòµÎãàÎã§.
env:
  AWS_REGION: ${{ vars.AWS_REGION }} # Î≥ÄÏàò Ï≤òÎ¶¨
  ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }} # Î≥ÄÏàò Ï≤òÎ¶¨
  EKS_CLUSTER_NAME: ${{ vars.EKS_CLUSTER_NAME }} # Î≥ÄÏàò Ï≤òÎ¶¨
  ENVIRONMENT: dev

jobs:
  build-and-deploy:
    name: üèóÔ∏è Build & Deploy (Dev)
    runs-on: ubuntu-latest
    environment: dev # Environment Ï∂îÍ∞Ä! (Secret Ï†ëÍ∑ºÏö©)
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: gha-dev-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: üîê Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: üîß Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üê≥ Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./app
          push: true
          tags: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest-dev
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: üîß Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: üîó Configure kubectl
        run: aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}

      # [ÏàòÏ†ï 1] TerraformÏóêÏÑú Dev ÌôòÍ≤ΩÏùò Role ARN Í∞ÄÏ†∏Ïò§Í∏∞
      - name: üî¢ Get IRSA Role ARN from Terraform
        id: irsa
        working-directory: terraform
        run: |
          # ‚ö†Ô∏è Ï§ëÏöî: Dev Î∞∞Ìè¨Ïù¥ÎØÄÎ°ú backends/dev.hclÏùÑ ÏÇ¨Ïö©Ìï¥Ïïº Ìï©ÎãàÎã§! (Prod ÏΩîÎìúÎ•º Í∑∏ÎåÄÎ°ú Î≥µÎ∂ôÌïòÎ©¥ Ïïà Îê®)
          terraform init -reconfigure -backend-config=backends/dev.hcl

          # Output Ïù¥Î¶ÑÏùÄ Í∞ôÏßÄÎßå, dev.hclÎ°ú Ï¥àÍ∏∞ÌôîÌñàÏúºÎØÄÎ°ú DevÏö© Role ARNÏù¥ ÎÇòÏòµÎãàÎã§.
          ROLE_ARN=$(terraform output -raw app_irsa_role_arn)
          echo "role_arn=$ROLE_ARN" >> $GITHUB_OUTPUT

      # [ÏàòÏ†ï 2] Dev ÌôòÍ≤ΩÏùò Kustomize ÌååÏùºÏóê Ï£ºÏûÖÌïòÍ∏∞
      - name: üíâ Inject IRSA ARN into Manifest
        run: |
          # ‚ö†Ô∏è Ï§ëÏöî: Í≤ΩÎ°úÍ∞Ä kustomize/overlays/dev/... Ïó¨Ïïº Ìï©ÎãàÎã§.
          sed -i "s|IRSA_ROLE_ARN_PLACEHOLDER|${{ steps.irsa.outputs.role_arn }}|g" kustomize/overlays/dev/patches/serviceaccount.yaml

          echo "Injection complete for Dev."

      # Dev ÌôòÍ≤ΩÏùÄ Î≥ÑÎèÑÏùò Î°§ÏïÑÏõÉ ÎåÄÍ∏∞ÎÇò Î≥¥Ïïà Ïä§Ï∫î ÏóÜÏù¥ Ï¶âÏãú Î∞òÏòÅ
      - name: üöÄ Deploy to Dev
        run: |
          cd kustomize/overlays/dev
          kustomize edit set image app=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest-dev
          kubectl apply -k .
          kubectl rollout status deployment/app -n app-dev --timeout=180s

      - name: üè• Run health check
        run: |
          kubectl port-forward svc/app-svc 8080:80 -n app-dev &
          PF_PID=$!
          sleep 10
          # [ÏàòÏ†ïÎê®] Ï†ïÌôïÌïú Health Check Í≤ΩÎ°ú (/api/v1/health)
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/v1/health || echo "000")
          kill $PF_PID 2>/dev/null || true
          if [ "$HTTP_STATUS" == "200" ]; then
            echo "‚úÖ Health check passed!"
          else
            echo "‚ùå Health check failed! (HTTP: $HTTP_STATUS)"
            exit 1
          fi

      # Dev ÏïåÎ¶ºÏùÄ Í∞ÑÏÜåÌïòÍ≤å
      - name: üì¢ Notify Slack
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "Dev Deploy: ${{ job.status }}",
              "blocks": [
                 {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Dev Deploy Finished* :${{ job.status == 'success' && 'white_check_mark' || 'x' }}:\nBranch: `develop`"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
